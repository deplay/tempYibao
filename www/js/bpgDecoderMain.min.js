var bestimg=angular.module("bestimg",[]);bestimg.provider("imageDataCache",function(){this.$get=["$cacheFactory",function($cacheFactory){return $cacheFactory("imageData")}]}),bestimg.service("canvas",[function(){this.init=function(){var cvs=document.createElement("canvas"),ctx=cvs.getContext("2d");return[cvs,ctx]},this.supported=function(){var elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))}}]),bestimg.service("webWorker",[function(){this.supported=function(){return!!window.Worker}}]),bestimg.factory("debounce",["$timeout",function($timeout){function debounce(fn,debounceTime){function _debounce(){$timeout.cancel(timeout),timeout=$timeout(fn,debounceTime)}var timeout;return _debounce}return debounce}]),bestimg.factory("DPQ",[function(){var DPQ=function(){function rangeCheck(length,fromIndex,toIndex){fromIndex>toIndex&&console.error("fromIndex("+fromIndex+") > toIndex("+toIndex+")"),fromIndex<0&&console.error(fromIndex),toIndex>length&&console.error(toIndex)}function swap(arr,i,j){var temp=arr[i];arr[i]=arr[j],arr[j]=temp}function dualPivotQuicksort(arr,left,right,div,property){var len=right-left;if(len<27)for(var i=left+1;i<=right;i++)for(var j=i;j>left&&arr[j][property]<arr[j-1][property];j--)swap(arr,j,j-1);else{var third=Math.floor(len/div),m1=left+third,m2=right-third;m1<=left&&(m1=left+1),m2>=right&&(m2=right-1),arr[m1][property]<arr[m2][property]?(swap(arr,m1,left),swap(arr,m2,right)):(swap(arr,m1,right),swap(arr,m2,left));for(var pivot1=arr[left][property],pivot2=arr[right][property],less=left+1,great=right-1,k=less;k<=great;k++)if(arr[k][property]<pivot1)swap(arr,k,less++);else if(arr[k][property]>pivot2){for(;k<great&&arr[great][property]>pivot2;)great--;swap(arr,k,great--),arr[k][property]<pivot1&&swap(arr,k,less++)}var dist=great-less;if(dist<13&&div++,swap(arr,less-1,left),swap(arr,great+1,right),dualPivotQuicksort(arr,left,less-2,div,property),dualPivotQuicksort(arr,great+2,right,div,property),dist>len-13&&pivot1!==pivot2)for(var k=less;k<=great;k++)arr[k][property]===pivot1?swap(arr,k,less++):arr[k][property]===pivot2&&(swap(arr,k,great--),arr[k][property]===pivot1&&swap(arr,k,less++));pivot1<pivot2&&dualPivotQuicksort(arr,less,great,div,property)}}var dualPivotQS={};return dualPivotQS.sort=function(arr,property,fromIndex,toIndex){return void 0===fromIndex&&void 0===toIndex?this.sort(arr,property,0,arr.length):(rangeCheck(arr.length,fromIndex,toIndex),dualPivotQuicksort(arr,fromIndex,toIndex-1,3,property)),arr},dualPivotQS}();return DPQ}]),bestimg.directive("bestimgContainer",function(){return{restrict:"A",controller:["$element",function($element){$element.data("bpgContainer",$element)}]}}),bestimg.service("containerSize",[function(){this.height=function(target){var ele=target[0]||target;if(ele)return"ION-CONTENT"===ele.tagName&&(ele=ele.childNodes[0]),ele.innerHeight||ele.clientHeight||document.documentElement&&document.documentElement.clientHeight||document.body&&document.body.clientHeight||window.innerHeight||null},this.width=function(target){var ele=target[0]||target;if(ele)return"ION-CONTENT"===ele.tagName&&(ele=ele.childNodes[0]),ele.innerWidth||ele.clientWidth||document.documentElement&&document.documentElement.clientWidth||document.body&&document.body.clientWidth||window.innerWidth||null},this.scrollTop=function(target){var ele=target[0]||target;if(ele){if("ION-CONTENT"===ele.tagName){var divScroll=ele.childNodes[0],transformValue=divScroll.style.transform,transformRegExp=/^translate3d\((-?[\d.]+)px, (-?[\d.]+)px, (-?[\d.]+)px\) scale\(([\d.]+)\)$/;if(transformRegExp.test(transformValue)){var match=transformValue.match(transformRegExp);return-match[2]}return ele.scrollTop||null}return ele.pageYOffset||ele.scrollTop||document.documentElement&&document.documentElement.scrollTop||document.body&&document.body.scrollTop||window.pageYOffset||null}},this.scrollBottom=function(target){var ele=target[0]||target;return this.scrollTop(target)+ele.clientHeight},this.scrollLeft=function(target){var ele=target[0]||target;if(ele){if("ION-CONTENT"===ele.tagName){var divScroll=ele.childNodes[0],transformValue=divScroll.style.transform,transformRegExp=/^translate3d\((-?[\d.]+)px, (-?[\d.]+)px, (-?[\d.]+)px\) scale\(([\d.]+)\)$/;if(transformRegExp.test(transformValue)){var match=transformValue.match(transformRegExp);return-match[1]}return ele.scrollLeft||null}return ele.pageXOffset||ele.scrollLeft||document.documentElement&&document.documentElement.scrollLeft||document.body&&document.body.scrollLeft||window.pageXOffset||null}},this.scrollRight=function(target){var ele=target[0]||target;return this.scrollLeft(target)+ele.clientWidth},this.offsetTop=function(eleWrap,conWrap){for(var ele=eleWrap[0]||eleWrap,con=conWrap[0]||conWrap,offsetTop=0;ele.offsetParent;){if(offsetTop+=ele.offsetTop,ele.offsetParent===con)return offsetTop;ele=ele.offsetParent}return null},this.offsetLeft=function(eleWrap,conWrap){for(var ele=eleWrap[0]||eleWrap,con=conWrap[0]||conWrap,offsetLeft=0;ele.offsetParent;){if(offsetLeft+=ele.offsetLeft,ele.offsetParent===con)return offsetLeft;ele=ele.offsetParent}return null}}]),bestimg.factory("eventToggle",["$window",function($window){function _eventToggle(jqWrap,toggle,fn){jqWrap&&toggle in{on:!0,off:!0}&&angular.isFunction(fn)&&("on"===toggle&&angular.element(document).ready(fn),angular.element($window)[toggle]("resize",fn),angular.element($window)[toggle]("scroll",fn),jqWrap[0]!==$window&&(jqWrap[toggle]("resize",fn),jqWrap[toggle]("scroll",fn)))}return _eventToggle}]),bestimg.factory("dPR",["$window",function($window){function _dPR(){return $window.devicePixelRatio||1}return _dPR}]),bestimg.factory("adjustSize",["dPR","bpgConfig",function(dPR,bpgConfig){function _adjustSize(size){return bpgConfig.supportDevicePixelRatio?+size*dPR():+size}return _adjustSize}]),bestimg.provider("bpgConfig",[function(){this.thresh=300,this.supportDevicePixelRatio=!0,this.defaultMap=[[320,"320"],[512,"512"],[640,"640"],[768,"768"],[1024,"1024"],[1200,"1200"],[1440,"1440"]],this.$get=function(){return this}}]),bestimg.directive("bestimg",["$q","$window","$rootScope","canvas","webWorker","debounce","DPQ","containerSize","eventToggle","loadImg","bpgConfig",function($q,$window,$rootScope,canvas,webWorker,debounce,DPQ,containerSize,eventToggle,loadImg,bpgConfig){return{restrict:"E",compile:function(tElement,tAttrs){function link(scope,element,attrs){holderImgDeferred.promise.then(function(){function _responseMain(){function loop(mode){for(var i=0,l=watcher.length,counter=0;i<l;i++)if("off"===mode)watcher[i].visited===!0&&counter++;else{if(scrollBottom<watcher[i].offsetTop)return;watcher[i].visited!==!0&&(loadImg(watcher[i].element,watcher[i].attrs),watcher[i].visited=!0)}counter===l&&eventToggle($container,"off",_response)}var scrollBottom=containerSize.scrollBottom($container);loop("off"),loop()}function _init($container){(watcher=$container.data("dataArr",watcher))||$container.data("dataArr",watcher=[]);var dataBox={offsetTop:containerSize.offsetTop(element,$container)-thresh,element:element,attrs:attrs};watcher.push(dataBox),DPQ.sort(watcher,"offsetTop")}var watcher,thresh=parseInt(attrs.thresh);isNaN(thresh)&&(thresh=bpgConfig.thresh);var $container=element.inheritedData("bpgContainer")||angular.element($window),_response=debounce(_responseMain,300);_init($container),eventToggle($container,"on",_response),scope.$on("bestimg.destroyed",_response),scope.$on("$destroy",function(){$rootScope.$broadcast("bestimg.destroyed"),eventToggle($container,"off",_response)})})}var holderImgDeferred=$q.defer(),placeHolderImgUrl="../img/placeholder.png",holderImg=new Image;holderImg.src=placeHolderImgUrl,holderImg.onload=function(){holderImgDeferred.resolve()};var tplEl=angular.element(holderImg);return tplEl.attr("class",tAttrs["class"]),tplEl.attr("style",tAttrs.style),tAttrs["canvas-supported"]=canvas.supported(),tAttrs["webWorker-supported"]=webWorker.supported(),tplEl.attr("thresh",tAttrs.thresh),tElement.replaceWith(tplEl),link}}}]),bestimg.factory("loadImg",["$q","$timeout","canvas","imageDataCache","bpgConfig","adjustSize",function($q,$timeout,canvas,imageDataCache,bpgConfig,adjustSize){function _loadImg(element,attrs){if(!attrs.imgSrc)return void console.log("need img-src");if(!attrs.imgSfx)return void console.log("need img-sfx");var map,adjustedWidth=adjustSize(element[0].width);if(map=attrs.map?JSON.parse(attrs.map.replace(/\'/g,'"')):bpgConfig.defaultMap,attrs["canvas-supported"]&&attrs["webWorker-supported"]){var canvasNew=canvas.init(),newCanvas=canvasNew[0],newContext=canvasNew[1],newCanvasWrapper=angular.element(newCanvas);newCanvasWrapper.attr("class",attrs["class"]),newCanvasWrapper.attr("style",attrs.style),$timeout(function(){function render(data){function d(){if(0===newCanvas.offsetHeight)return void setTimeout(d,500);var a=n;++a>=f.length&&(0===loopCount||q<loopCount?(a=0,q++):a=-1),0<=a&&(n=a,newContext.putImageData(f[a].img,0,0),setTimeout(d,f[a].duration))}var n,q,f=data.frames,g=f[0].img,loopCount=0;newCanvas.width=g.width,newCanvas.height=g.height,newContext.putImageData(g,0,0),1<f.length&&(n=0,q=0,setTimeout(d,f[0].duration)),element.replaceWith(newCanvas)}var fullPath,skipFlag=!1;if(angular.forEach(map,function(v){skipFlag!==!0&&adjustedWidth<v[0]&&(fullPath="../"+attrs.imgSrc+"@"+v[1]+attrs.imgSfx+".bpg",skipFlag=!0)}),!fullPath){var v=map[map.length-1];fullPath="../"+attrs.imgSrc+"@"+v[1]+attrs.imgSfx+".bpg"}var cachedImageDataPromise=imageDataCache.get(fullPath);if(cachedImageDataPromise)cachedImageDataPromise.then(function(cachedImageData){render(cachedImageData)},function(){console.log("获取promise失败")});else{var deferred=$q.defer();imageDataCache.put(fullPath,deferred.promise);var decodeWorker=new Worker("./js/bpgDecoderWorker.min.js");decodeWorker.onmessage=function(e){if(!e.data.width||!e.data.height||e.data.frames&&e.data.frames.length){if(e.data.frames&&e.data.frames.length){for(var f=e.data.frames,canvasNew=canvas.init(),ctx=canvasNew[1],i=0,l=f.length;i<l;i++){var imageData=ctx.createImageData(e.data.width,e.data.height);imageData.data.set(f[i].img),f[i].img=imageData}deferred.resolve(e.data),render(e.data)}}else{var wrapper=function(){var canvasNew=canvas.init(),ctx=canvasNew[1],imageData=ctx.createImageData(e.data.width,e.data.height);return imageData};decodeWorker.postMessage(wrapper())}},decodeWorker.postMessage({url:fullPath})}})}else{var newImage=new Image,newImageWrapper=angular.element(newImage);newImageWrapper.attr("class",attrs["class"]),newImageWrapper.attr("style",attrs.style),$timeout(function(){var fullPath,skipFlag=!1;if(angular.forEach(map,function(v){skipFlag!==!0&&adjustedWidth<v[0]&&(fullPath=attrs.imgSrc+"@"+v[1]+attrs.imgSfx,newImage.src=fullPath,skipFlag=!0)}),!fullPath){var v=map[map.length-1];fullPath=attrs.imgSrc+"@"+v[1]+attrs.imgSfx,newImage.src=fullPath}newImage.onload=function(){element.replaceWith(newImage)}})}}return _loadImg}]);